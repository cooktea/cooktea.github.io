---
title: 家庭监控系统搭建（折腾）
date: 2022-07-01
categories:
- Learning Something
---
# 前言
2022年3月的一个周末，笔者在上海穿着棉袄跟好友在深夜的街头撸着烧烤。万万没想到的是这竟然是未来三个月内笔者吃到的最后一顿烧烤。居家办公的日子总是在摸鱼与爆肝之间反复交替，恰逢给老家安装监控这件事早已有所计划，索性便用摸鱼的时间将其落地。
# 为什么要装监控   
## 正经的的理由
1. 最近村子里修了柏油马路，村后的河堤也修成了永久性的水泥堤坝并通上了路。最近经常有很多陌生面孔从村子里经过，加之70多岁的奶奶在半封闭的院子里种了玉米，为了不让玉米被晨练或遛狗的路人顺手牵羊，需要安装几个监控聊以自慰。（虽然整套监控装下来的费用够买一吨玉米了
2. 住在一起乐于捕鱼的叔叔晒在院子里的渔网最近总是莫名失窃，怀疑是村子里有不对付的人家故意破坏，让我装个监控以便坐实证据。
3. 老爹常年在外面工作，对家里的情况放心不下。装个监控也好一定程度上缓解下这个中年男人的思乡情切。  

## 不那么正经的理由
1. 生命在于折腾，还有什么比亲手装一套监控更有成就感呢。顺便点下技能树，万一以后失业了说不定还能靠这个混口饭吃。
2. FFmpeg的书买回来一年了塑料封皮都还没拆，借着装监控的机会倒逼自己把FFmpeg的技能点一下。
3. 终于有理由采购心心念念的二手洋垃圾服务器和交换机了。（这个才是重点  

# 假装有需求分析
考虑到奶奶的苞米地，叔叔的渔网以及老爹的思乡情，再考虑下上述三个人加起来都不一定能分得清鼠标左右键，最终决定在常规的监控系统下，一定要有一套机制能够让上述几人在手机上可以进行监控的查看及录像回放等功能。  
主要需求如下：  
1. 监控范围能覆盖家里和外界联通的几个门以及奶奶的苞米地和叔叔晒渔网的地方
2. 能在手机上查看实时监控以及录像
3. 没了  

# 需要买些啥
俗话说巧妇难为无米之炊，没有硬件设备就是大罗神仙下凡也搞不定搭监控这件事。所以采购必须的设备及辅材就成了关键，由于笔者的所有社会关系总和内都跟安装监控这件事扯不上关系，（说人话就是没熟人。所以需要从头了解监控系统的组成，经过一番努力，总算了解了一个大概。  
监控系统是以NVR为中心，通过交换机管理IP摄像头并获取视频流。之后NVR将视频流进行滚动存储，以实现录像的功能。听起来感觉很简单的样子，所以这就先去买个NVR。  
等等，我都自己装监控了，直接买NVR也太简单了吧。这不是有手就行？而且市场上的NVR主要有海康威视和大华等，如果要实现手机上就能操作，还需要额外付费购买这些公司的云产品。作为一个给小姐姐之家（百度云）开会员都扣扣索索的男人怎么可能会因为这种事情就掏出我的钱包。打咩！！！  
经过一番调查，最终还是GayHub yyds。对比了多款开源NVR之后，笔者最终还是在ISpy，shinobi，Zoneminder中选择了ZoneMinder作为整套监控系统的核心。之所以选择ZoneMinder是因为其可以作为独立的服务部署在linux系统上，并通过web进行管理和使用。同时很重要的一点是，Zoneminder有社区支持的移动端APP，对于家里的中老年人来说十分友好。  
最重要的NVR搞定之后，剩下来就是一些比较“常见”的设备了。具体的设备清单及费用在下面了。  

| 设备名 | 参数 | 数量 | 价格 | 备注 |
| --- | --- | --- | --- | --- |
| 服务器| 华为RH2288HV2 | 1 | 1000 | 捡垃圾 |
| 内存 | 8G | 4 | 220 | 捡垃圾 |
| CPU | E52650V2 | 2 | 80 | 捡垃圾 |
| 硬盘 | 4T | 1 | 280 | 矿盘 |
| 交换机 | 100M | 1 | 80 | |
| 交换机 | 1000M | 1 | 110 | |
| 监控头 | 4mm | 3 | 155 | 二手 |
| 监控头 | 6mm | 1 | 45 | 二手 |
| 监控头 | 12mm | 1 | 65 | 二手 |
| 监控电源 | 12v | 5 | 50 | |
| 监控用室外网线| | 150m | 100 | |
| 监控用电源线| | 150m | 100 | |

# 开干   
## 没有金刚钻，别揽瓷器活
由于笔者是一个体重接近200斤的死肥宅，为了家里的房顶着想，所以上房布线安装监控头这件事最终还是落到了我的父亲身上。虽然他已经年近50，上次爬房顶的时候可能还没有我，但是既然东西都买回来了，那硬着头皮也得上了。  
俗话说上阵父子兵，在我和老爹紧密的配合下，他仿佛找回了年轻时的状态，左手提溜着冲击钻，右手拿着监控设备在家里年久失修的房顶上辗转腾挪，笔者则干回了老本行，一个下午打了20个水晶头。  
经过一下午的奋战，在笔者和老爹的共同努力下，最终还是将5个监控摄像头安装在了计划的位置，并连接好了网线和电源线。经此一役，我们俩得出了一个共识，那就是趁早断了以后靠装监控混饭吃的想法，按照我俩的速度，以后可能会被饿死。  
## 回到主场  
众所周知，笔者是一个不那么正经的程序员。（正经人谁会自己装监控啊）。程序员擅长的自然是坐在电脑前面，一杯茶一包烟一个BUG修一天。在硬件设备均已安装完成后，笔者将所有监控摄像头连上百兆交换机后，再将百兆交换机与千兆交换机相连。千兆交换机则与服务器和路由器连接。这样网络方面就简简单单的配置完成了。拓扑如下图所示。  
![](https://cooktea.github.io/assets/images/monitor-system-network-layout.png)
## 软件部署  
### 服务器
由于笔者是第一次买二手服务器，之前也没有服务器的运维经验，所以一开始并没有想好服务器应该怎么利用。最终在查询过相关资料后，决定在物理机上安装ESXI作为虚拟化平台，利用ESXI虚拟出来的虚拟机负载业务。安装ESXI的过程按下不表，网络上有很多相关的教程。   
笔者的这台华为RH2288Hv2的配置是两颗E52650V2提供16核32线程，同时插了4跟单条8G的DDR3RECC内存，一共是32G。硬盘方面采购了一块4T的SATA机械硬盘作为主要的数据存储，一快128G的杂牌SSD作为ESXI的系统盘。一块从废旧笔记本上拆下来的500G机械硬盘以及几块数年前捡垃圾捡到的250G机械硬盘。   
### 虚拟机
由于笔者实在是太懒了，搭建这个监控系统已经耗费了笔者过多的心血，此时此刻写这篇文章的时候已经是累觉不爱了。所以凡是网上能查到的资料笔者均不再废话。部署虚拟机以及部署ZoneMinder在网上都能查到，这里就不再叙述了。笔者给ZoneMinder分配了一台4核4G，1.6T硬盘的虚拟机。实测在5个720P摄像头的工况下，平均CPU占用为25%，内存在1.4G左右。1.6T的硬盘可以支持14天的全时段录像存储。
下面是一些ZoneMinder的系统截图。
![](https://cooktea.github.io/assets/images/Snipaste_2022-07-03_17-00-10.png)
![](https://cooktea.github.io/assets/images/Snipaste_2022-07-03_17-00-50.png)
![](https://cooktea.github.io/assets/images/Snipaste_2022-07-03_17-01-25.png)

## 一些小乐子
### 薅阿里云羊毛
笔者在一切正经功能都部署安装调试完成后，突然觉得有那么一丝空虚。世界上得监控系统千篇一律，那么我与世界得参差又在哪里呢。作为一个不正经得程序员，自然而然就有那么一丝蠢蠢欲动。于是说干就干，笔者写了一个脚本，通过Jenkins调用，可以收集某个监控摄像头在某一天得全天录像，并通过FFmpeg转码成H265格式，最后倍速X10输出一个时长为2.4小时的视频并上传至阿里云盘。虽然不清楚这么做除了浪费服务器的算力以外还有什么用，但是好像确实有满足了一颗乐于折腾的心。
### 送牛奶的叔叔好辛苦
由于ZoneMinder的警戒功能并不好用，所以笔者思忖良久（闲得无聊）最终还是决定实现一套自研的警戒功能。该功能通过Jenkins的定时任务触发，会在每天的夜里检测各个摄像头下是否有人出现（当一个Python调包侠真爽）。如果有人出现的话则会记录当时的图片并在任务结束前通过电子邮件的形式发送给我和我老爹。  
比较有趣的是，该任务上线的第一天就在凌晨两点半拍到了给家里送牛奶的叔叔。直到这时候我才知道，在万家灯火下，在月明星稀下，一定会有人为了生计在奔波。第二天的牛奶我喝的格外虔诚。附一张送牛奶的叔叔的高糊帅照。
![](https://cooktea.github.io/assets/images/Snipaste_2022-07-03_16-58-58.png)


